version: '3.8'

services:
  highseat:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: highseat
    restart: unless-stopped
    ports:
      - "${PORT:-3350}:3350"
    environment:
      - NODE_ENV=production
      - PORT=3350
      - DATABASE_PATH=/app/db/dash.db
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET must be set in .env file}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-15m}
      - JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN:-7d}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:?ENCRYPTION_KEY must be set in .env file}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3350}
      - UPLOAD_MAX_SIZE=${UPLOAD_MAX_SIZE:-10485760}
      - MONITOR_DOCKER_HOST=${MONITOR_DOCKER_HOST:-false}
      - DEFAULT_ADMIN_USERNAME=${DEFAULT_ADMIN_USERNAME:-admin}
      - DEFAULT_ADMIN_PASSWORD=${DEFAULT_ADMIN_PASSWORD:-admin123}
      - DEFAULT_ADMIN_DISPLAY_NAME=${DEFAULT_ADMIN_DISPLAY_NAME:-Administrator}
    volumes:
      # Database persistence
      - highseat-db:/app/db
      # Uploads persistence
      - highseat-uploads:/app/uploads
      # Optional: Mount Docker socket for container monitoring (if MONITOR_DOCKER_HOST=true)
      # - /var/run/docker.sock:/var/run/docker.sock:ro
      # Optional: Mount host /proc and /sys for system monitoring
      # - /proc:/host/proc:ro
      # - /sys:/host/sys:ro
    networks:
      - highseat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3350/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

volumes:
  highseat-db:
    driver: local
  highseat-uploads:
    driver: local

networks:
  highseat-network:
    driver: bridge
