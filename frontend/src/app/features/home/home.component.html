<div class="home-container">
  @if (loading()) {
    <div class="loading-overlay">
      <fa-icon [icon]="faSpinner" class="icon-xl"></fa-icon>
      <p>Loading dashboard...</p>
    </div>
  } @else {
    <!-- Top Navigation Bar -->
    <header class="top-nav">
      <div class="nav-left">
        @if (!user()?.hideLogo) {
          <img src="/header.png" alt="Highseat" class="app-logo" />
        }
      </div>

      <!-- Board Tabs (only show if multiple boards) -->
      @if (boards().length > 1) {
        <nav class="board-tabs" cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="onBoardTabDrop($event)">
          @for (board of boards(); track board.id) {
            <button
              class="board-tab"
              [class.active]="selectedBoardSlug() === board.slug"
              [class.home-board]="isHomeBoard(board)"
              (click)="selectBoard(board)"
              (contextmenu)="onBoardTabRightClick($event, board)"
              cdkDrag
            >
              @if (getIconForBoard(board)) {
                <fa-icon [icon]="getIconForBoard(board)!" class="board-icon"></fa-icon>
              } @else if (isHomeBoard(board)) {
                <fa-icon [icon]="faHome" class="home-icon"></fa-icon>
              }
              {{ board.name }}
            </button>
          }
        </nav>
      }

      <!-- User Actions -->
      <div class="nav-right">
        <!-- Add Card/Service Discovery Menu (only in design mode) -->
        @if (designMode.isDesignMode()) {
          <div class="menu-container" *hasPermission="'card:add'">
            <button class="btn btn-primary" (click)="toggleAddMenu()" title="Add">
              <fa-icon [icon]="faPlus" class="icon-sm"></fa-icon>
            </button>

            @if (showAddMenu()) {
              <div class="dropdown-menu">
                <button class="menu-item" (click)="openAddCardFromMenu()">
                  <fa-icon [icon]="faPlus" class="icon-sm"></fa-icon>
                  <span>Add Card</span>
                </button>

                <button class="menu-item" (click)="openServiceDiscovery()">
                  <fa-icon [icon]="faNetworkWired" class="icon-sm"></fa-icon>
                  <span>Discover Services</span>
                </button>
              </div>
            }
          </div>
        }

        <!-- Hamburger Menu -->
        <div class="menu-container">
          <button class="btn btn-secondary" (click)="toggleMenu()" title="Menu">
            <fa-icon [icon]="faBars" class="icon-sm"></fa-icon>
          </button>

          @if (showMenu()) {
            <div class="dropdown-menu">
              <button class="menu-item" (click)="toggleDesignMode()" *hasPermission="'board:design'">
                <fa-icon [icon]="faPencil" class="icon-sm"></fa-icon>
                <span>{{ designMode.isDesignMode() ? 'Exit Design' : 'Design Mode' }}</span>
              </button>

              <div class="menu-divider"></div>

              <button class="menu-item" (click)="openBackgroundSettings()" *hasPermission="'board:edit'">
                <fa-icon [icon]="faImage" class="icon-sm"></fa-icon>
                <span>Background</span>
              </button>

              <button class="menu-item" (click)="navigateToThemes()">
                <fa-icon [icon]="faPalette" class="icon-sm"></fa-icon>
                <span>Themes</span>
              </button>

              <button class="menu-item" (click)="openSettingsFromMenu()" *hasPermission="'board:edit'">
                <fa-icon [icon]="faCog" class="icon-sm"></fa-icon>
                <span>Settings</span>
              </button>
            </div>
          }
        </div>

        @if (user()) {
          <button class="btn btn-secondary" (click)="logout()" title="Logout">
            <fa-icon [icon]="faRightFromBracket" class="icon-sm"></fa-icon>
          </button>
        }
      </div>
    </header>

    <!-- Board Content -->
    <main class="board-container">
      @if (boards().length === 0) {
        <div class="empty-state">
          <h2>Welcome to Highseat!</h2>
          <p>Get started by creating your first board.</p>
          <button class="btn btn-primary" (click)="openSettings()" *hasPermission="'board:edit'">
            <fa-icon [icon]="faPlus" class="icon-sm"></fa-icon>
            <span>Create Board</span>
          </button>
        </div>
      } @else if (selectedBoard()) {
        <!-- Embed the board view directly -->
        <div class="embedded-board-view">
          <app-board-view [boardSlug]="selectedBoardSlug()!"></app-board-view>
        </div>
      }
    </main>

    <!-- Service Discovery Modal -->
    @if (serviceDiscoveryModal.showModal()) {
      <app-service-discovery-modal
        (servicesSelected)="handleServicesDiscovered($event)"
        (cancelled)="serviceDiscoveryModal.close()"
      ></app-service-discovery-modal>
    }

    <!-- Icon Picker Modal -->
    @if (iconPickerModal.showModal()) {
      <app-icon-picker-modal
        (iconSelected)="handleIconSelected($event)"
        (cancelled)="iconPickerModal.close()"
      ></app-icon-picker-modal>
    }
  }
</div>
